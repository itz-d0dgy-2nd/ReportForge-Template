<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Template CSS-->
        <link rel="stylesheet" href="{{ .Path }}/0_report_template/html/styles/template.css">
        <link rel="stylesheet" href="{{ .Path }}/0_report_template/html/styles/severity-matrix.css">
        <link rel="stylesheet" href="{{ .Path }}/0_report_template/html/styles/severity-bar-graph.css">
        <link rel="stylesheet" href="{{ .Path }}/0_report_template/html/styles/custom.css">

        <!-- Template JS-->
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/template.js"></script>

        <!-- Google Fonts -->
        <link rel="stylesheet" href="{{ .Path }}/0_report_template/html/styles/exo2/font-exo2.css">
        <link rel="stylesheet" href="{{ .Path }}/0_report_template/html/styles/helvetica-neue/font-helvetica-neue.css">

        <!-- Prism.js Core -->
        <link rel="stylesheet" href="{{ .Path }}/0_report_template/html/styles/prismjs/prism-tomorrow.min.css">
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/prismjs/prism.min.js"></script>
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/prismjs/prism-markup.min.js"></script>
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/prismjs/prism-markup-templating.min.js"></script>
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/prismjs/prism-php.min.js"></script>
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/prismjs/prism-go.min.js"></script>
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/prismjs/prism-python.min.js"></script>
        <script rel="javascript" src="{{ .Path }}/0_report_template/html/scripts/prismjs/prism-csharp.min.js"></script>
        
    <title>{{ .Metadata.TargetInformation.TargetName }} - {{ .Metadata.TargetInformation.TargetTest }}</title>
    </head>

    <body>
        <a href="#main-content" class="skip-link" aria-label="Skip to main content">Skip to main content</a>
        <main role="main" id="main-content">
            {{- template "metadata" . }}
            {{- template "table-of-contents" . }}
            {{- template "document-information" . }}
            {{- template "summaries" . }}
            {{- template "table-of-findings" . }}
            {{- template "severity-matrix" . }}
            {{- template "severity-bar-graph" . }}
            {{- template "findings" . }}
            {{- template "suggestions" . }}
            {{- template "appendices" . }}
            {{- template "document-status-indicator" . }}
        </main>
    </body>
</html>

<!-- Metadata Template -->
{{- define "metadata" }}
{{- if .Metadata }}
<section id="metadata" class="metadata-section" aria-label="Document Information - Latest">
    <div class="front-page"></div>
    <div class="overlay-image"></div>
    <article>
        <h1>{{ .Metadata.TargetInformation.TargetName }}</h1>
        <h1>{{ .Metadata.TargetInformation.TargetTest }}</h1>
        <table role="table" aria-label="Information Table - Latest">
            <tbody>
                <tr><th scope="row">Client: </th><td>{{ .Metadata.Client }}</td></tr>
                {{- range .Metadata.DocumentInformation }}
                {{- if .DocumentCurrent }}
                <tr><th scope="row">Document Status: </th><td>{{ .DocumentVersioning.DocumentStatus }}</td></tr>
                <tr><th scope="row">Document Version: </th><td>{{ .DocumentVersioning.DocumentVersion }}</td></tr>
                <tr><th scope="row">Document Date: </th><td>{{ .DocumentVersioning.DocumentDate }}</td></tr>
                <tr><th scope="row">Document Stage: </th><td>{{ .DocumentVersioning.DocumentStage }}</td></tr>
                {{- end }}
                {{- end }}
            </tbody>
        </table>
    </article>
    <div class="page-break"></div>
</section>
{{- end }}
{{- end }}

<!-- Table of Contents Template -->
{{- define "table-of-contents" }}
{{- if .Metadata }}
<section id="table-of-contents" class="table-of-contents-section" aria-label="Table of Contents">
    <h1>Table of Contents</h1>
    <nav role="navigation">
        <ul>
            {{- if .Metadata.DocumentInformation }}
            <li><a href="#document-information" aria-label="Navigate to Document Information">Document Information</a></li>
            {{- end }}
            {{- if .Summaries }}
            <li><a href="#execsum" aria-label="Navigate to Executive Summary">Executive Summary</a></li>
            <li><a href="#techsum" aria-label="Navigate to Technical Summary">Technical Summary</a></li>
            {{- end }}
            {{- if .Findings }}
            <li><a href="#table-of-findings" aria-label="Navigate to Findings Table">Findings Table</a></li>
            {{- end }}
            {{- if .Severity }}
                {{- if .Severity.DisplaySeverityMatrix }}<li><a href="#severity-matrix" aria-label="Navigate to Severity Matrix">Severity Matrix</a></li>{{ end }}
                {{- if .Severity.DisplaySeverityBarGraph }}<li><a href="#severity-bar-graph" aria-label="Navigate to Severity Bar Graph">Severity Bar Graph</a></li>{{ end }}
            {{- end }}
            {{- if .Findings }}
            {{- $lastDirectory := "" }}
            {{- range .Findings }}
            {{- if ne .Directory $lastDirectory }}
            <li><a href="#findings-{{ .Directory }}" aria-label="Navigate to {{ .Directory }} Findings">Findings - {{ .Directory }}</a></li>
            {{- $lastDirectory = .Directory }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- if .Suggestions }}
            {{- $lastDirectory := "" }}
            {{- range .Suggestions }}
            {{- if ne .Directory $lastDirectory }}
            <li><a href="#suggestions-{{ .Directory }}" aria-label="Navigate to {{ .Directory }} Suggestions">Suggestions - {{ .Directory }}</a></li>
            {{- $lastDirectory = .Directory }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- if .Appendices }}
            {{- $lastDirectory := "" }}
            {{- range .Appendices }}
            {{- if ne .Directory $lastDirectory }}
            <li><a href="#appendices-{{ .Directory }}" aria-label="Navigate to {{ .Directory }} Appendices">Appendices - {{ .Directory }}</a></li>
            {{- $lastDirectory = .Directory }}
            {{- end }}
            {{- end }}
            {{- end }}
        </ul>
    </nav>
    <div class="page-break"></div>
</section>
{{- end }}
{{- end }}

<!-- Document Information Template -->
{{- define "document-information" }}
{{- if .Metadata }}
<section id="document-information" class="document-information-section" aria-label="Document Information - Complete">
    <h1>Document Information</h1>
    <table role="table" aria-label="Information Table - Complete">
        <thead>
            <tr>
                <th scope="col">Status</th>
                <th scope="col">Version</th>
                <th scope="col">Date</th>
                <th scope="col">Stage</th>
                <th scope="col">Contributor</th>
            </tr>
        </thead>
        <tbody>
            {{- range .Metadata.DocumentInformation }}
            <tr>
                <td>{{ .DocumentVersioning.DocumentStatus }}</td>
                <td>{{ .DocumentVersioning.DocumentVersion }}</td>
                <td>{{ .DocumentVersioning.DocumentDate }}</td>
                <td>{{ .DocumentVersioning.DocumentStage }}</td>
                <td>{{ .DocumentVersioning.DocumentContributor }}</td>
            </tr>
            {{- end }}
        </tbody>
    </table>
    <h1>Document Stakeholders</h1>
    <table role="table" aria-label="Stakeholders Table">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Company</th>
                <th scope="col">Role</th>
            </tr>
        </thead>
        <tbody>
            {{- range .Metadata.StakeholderInformation }}
            <tr>
                <td>{{ .StakeholderName }}</td>
                <td>{{- if .StakeholderCompany }}{{- if ne .StakeholderCompany $.Metadata.Client }}{{ .StakeholderCompany }}{{- else }}{{ $.Metadata.Client }}{{- end }}{{- else }}{{ $.Metadata.Client }}{{- end }}</td>
                <td>{{ .StakeholderRole }}</td>
            </tr>
            {{- end }}
        </tbody>
    </table>
    <div class="page-break"></div>
</section>
{{- end }}
{{- end }}

<!-- Summaries Template -->
{{- define "summaries" }}
{{- if .Summaries }}
<section id="execsum" class="execsum-section" aria-label="Executive Summary">
    <h1>Executive Summary</h1>
    {{- range .Summaries }}
    {{- if eq .FileName "execsum.md" }}{{ .Body }}{{- end }}
    {{- end }}
    <div class="page-break"></div>
</section>

<section id="techsum" class="techsum-section" aria-label="Technical Summary">
    <h1>Technical Summary</h1>
    {{- range .Summaries }}
    {{- if eq .FileName "techsum.md" }}{{ .Body }}{{- end }}
    {{- end }}
    <div class="page-break"></div>
</section>
{{- end }}
{{- end }}

<!-- Summary Table Template -->
{{- define "table-of-findings" }}
{{- if .Findings }}
<section id="table-of-findings" class="table-of-findings-section" aria-label="Table of Findings">
    <h1>Findings Table</h1> 
    <table role="table">
        <thead>
            <tr>
                <th scope="col">Finding ID</th>
                <th scope="col">Finding Name</th>
                <th scope="col">Finding Status</th>
                <th scope="col">Finding Severity</th>
            </tr>
        </thead>
        <tbody>
            {{- range .Findings }}
            <tr>
                <td><a href="#{{ .FileName }}" aria-label="Navigate to detailed finding {{ .Headers.FindingID }}">{{ .Headers.FindingID }}</a></td>
                <td class="finding-name">{{ .Headers.FindingTitle }}</td>
                <td class="finding-status" data-status="{{ .Headers.FindingStatus }}">{{ .Headers.FindingStatus }}</td>
                <td class="finding-severity" data-severity="{{ .Headers.FindingSeverity }}"> {{ .Headers.FindingSeverity }} </td>
            </tr>
            {{- end }}
        </tbody>
    </table>
    <div class="page-break"></div>
</section>
{{- end }}
{{- end }}

<!-- Severity Matrix Template -->
{{- define "severity-matrix" }}
{{- if .Severity.DisplaySeverityMatrix }}
<section id="severity-matrix" class="severity-matrix-section" aria-label="Severity Matrix">
    <h1>Findings Assessment</h1> 
    <table role="table" aria-label="Severity Matrix Table">
        <thead>
            <tr>
                <th scope="col"></th>
                {{- if $.Severity.FlipSeverityMatrix }}
                    {{- range .Severity.Impacts }}<th scope="col">{{ . }}</th>{{- end }}
                {{- else }}
                    {{- range .Severity.Likelihoods }}<th scope="col">{{ . }}</th>{{- end }}
                {{- end }}
            </tr>
        </thead>
        <tbody>
            {{- range $rowIndex, $intersections := .Severity.Matrix }}
            <tr>
                <th scope="row">
                    {{- if $.Severity.FlipSeverityMatrix }}
                        {{- index $.Severity.Likelihoods $rowIndex }}
                    {{- else }}
                        {{- index $.Severity.Impacts $rowIndex }}
                    {{- end -}}
                </th>
                {{- range $columnIndex, $intersectionString := $intersections }}
                <td class="finding-severity" data-severity="{{ index (index $.Severity.CalculatedMatrix $rowIndex) $columnIndex }}">
                    {{- $ids := split $intersectionString ", " -}}
                    {{- range $id := $ids -}}
                    {{- range $.Findings -}}
                        {{- if eq .Headers.FindingID $id -}}
                        <a href="#{{ .FileName }}">{{ $id }}</a>
                        {{- end -}}
                    {{- end -}}
                    {{- end -}}
                </td>
                {{- end }}
            </tr>
            {{- end }}
        </tbody>
    </table>
    <div class="page-break"></div>
</section>
{{- end }}
{{- end }}

<!-- Severity Bar Graph Template -->
{{- define "severity-bar-graph" }}
{{- if .Severity.DisplaySeverityBarGraph }}
<section id="severity-bar-graph" class="severity-graph-section" aria-label="Severity Bar Graph">
    <h1>Findings Assessment</h1>
    {{- $total := len .Findings }}
    {{- $low := 0 }}
    {{- $medium := 0 }}
    {{- $high := 0 }}
    {{- $critical := 0 }}
    {{- range .Findings }}
        {{- if eq .Headers.FindingSeverity "Low" }}
            {{- $low = inc $low }}
        {{- else if eq .Headers.FindingSeverity "Medium" }}
            {{- $medium = inc $medium }}
        {{- else if eq .Headers.FindingSeverity "High" }}
            {{- $high = inc $high }}
        {{- else if eq .Headers.FindingSeverity "Critical" }}
            {{- $critical = inc $critical }}
        {{- end }}
    {{- end }}
    <div class="bar-graph-vertical">
        <div class="bar-container-vertical">
            <meter class="bar finding-severity" data-severity="Low" value="{{ $low }}" max="{{ $total }}" aria-label="Low severity: {{ $low }} of {{ $total }} findings"></meter>
            <span class="label">Low</span>
        </div>
        <div class="bar-container-vertical">
            <meter class="bar finding-severity" data-severity="Medium" value="{{ $medium }}" max="{{ $total }}" aria-label="Medium severity: {{ $medium }} of {{ $total }} findings"></meter>
            <span class="label">Medium</span>
        </div>
        <div class="bar-container-vertical">
            <meter class="bar finding-severity" data-severity="High" value="{{ $high }}" max="{{ $total }}" aria-label="High severity: {{ $high }} of {{ $total }} findings"></meter>
            <span class="label">High</span>
        </div>
        <div class="bar-container-vertical">
            <meter class="bar finding-severity" data-severity="Critical" value="{{ $critical }}" max="{{ $total }}" aria-label="Critical severity: {{ $critical }} of {{ $total }} findings"></meter>
            <span class="label">Critical</span>
        </div>
    </div>
    <div class="page-break"></div>
</section>
{{- end }}
{{- end }}

<!-- Findings Template -->
{{- define "findings" }}
{{- if .Findings }}
{{- $lastDirectory := "" }}
{{- range .Findings }}
{{- if ne .Directory $lastDirectory }}
{{- if ne $lastDirectory "" }}</section>{{- end }}
<section id="findings-{{ .Directory }}" class="findings-section" aria-label="Findings - {{ .Directory }}">
    <h1>{{ .Directory }} Findings</h1>
{{- end }}
    
    <article id="{{ .FileName }}" class="finding" aria-label="Finding - {{ .Headers.FindingTitle }}">
        <h2>{{ .Headers.FindingID }} - {{ .Headers.FindingTitle }}</h2>
        <table role="table" aria-label="Finding Table">
            <thead>
                <tr>
                    <th scope="col">Finding Status</th>
                    {{- if $.Severity.ConductSeverityAssessment }}
                        <th scope="col">Finding Impact</th>
                        <th scope="col">Finding Likelihood</th>
                    {{- end }}
                    <th scope="col">Finding Severity</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="finding-status" data-status="{{ .Headers.FindingStatus }}">{{ .Headers.FindingStatus }}</td>
                    {{- if $.Severity.ConductSeverityAssessment }}
                        <td>{{ .Headers.FindingImpact }}</td>
                        <td>{{ .Headers.FindingLikelihood }}</td>
                    {{- end }}
                    <td class="finding-severity" data-severity="{{ .Headers.FindingSeverity }}">{{ .Headers.FindingSeverity }}</td>
                </tr>
            </tbody>
        </table>
        {{ .Body }}
    </article>
    <div class="page-break"></div>
    {{- $lastDirectory = .Directory }}
    {{- end }}
</section>
{{- end }}
{{- end }}

<!-- Suggestions Template -->
{{- define "suggestions" }}
{{- if .Suggestions }}
{{- $lastDirectory := "" }}
{{- range .Suggestions }}
{{- if ne .Directory $lastDirectory }}
{{- if ne $lastDirectory "" }}</section>{{- end }}
<section id="suggestions-{{ .Directory }}" class="suggestions-section" aria-label="Suggestions - {{ .Directory }}">
    <h1>{{ .Directory }} Suggestions</h1> 
    {{- end }}
    <article id="{{ .FileName }}" class="suggestion" aria-label="Suggestion - {{ .Headers.SuggestionTitle }}">
        <h2>{{ .Headers.SuggestionID }} - {{ .Headers.SuggestionTitle }}</h2>
        {{ .Body }}
    </article>
    <div class="page-break"></div>
    {{- $lastDirectory = .Directory }}
{{- end }}
</section>
{{- end }}
{{- end }}

<!-- Appendices Template -->
{{- define "appendices" }}
{{- if .Appendices }}
{{- $lastDirectory := "" }}
{{- range .Appendices }}
{{- if ne .Directory $lastDirectory }}
{{- if ne $lastDirectory "" }}</section>{{- end }}
<section id="appendices-{{ .Directory }}" class="appendices-section" aria-label="Appendices - {{ .Directory }}">
    <h1>{{ .Directory }} Appendices</h1> 
    {{- end }}
    <article id="{{ .FileName }}" class="appendices" aria-label="Appendix - {{ .Headers.AppendixTitle }}">
        <h2>{{ .Headers.AppendixTitle }}</h2>
        {{ .Body }}
    </article>
    <div class="page-break"></div>
    {{- $lastDirectory = .Directory }}
{{- end }}
</section>
{{- end }}
{{- end }}

<!-- Document Status Indicator Template -->
{{- define "document-status-indicator" }}
{{- if .Metadata }}
{{- range .Metadata.DocumentInformation }}
{{- if .DocumentCurrent }}
{{- if eq .DocumentVersioning.DocumentStatus "Draft" }}
<p class="AE3CEE3B46BEBFFE161D55F7AF5F97F1"></p>
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
